<UserControl x:Class="Aksl.Modules.Others.Views.EmployeeItemView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ei="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:models="clr-namespace:Aksl.Modules.Others.OrgChart.Models"
             xmlns:converters="clr-namespace:Aksl.Modules.Others.OrgChart"
             xmlns:views="clr-namespace:Aksl.Modules.Others.Views"
             mc:Ignorable="d"
             d:DesignHeight="300"
             prism:ViewModelLocator.AutoWireViewModel="True">
    <UserControl.Resources>

        <converters:CountToVisibilityConverter x:Key="CountToVis" />

        <DataTemplate x:Key="orgChartDataTemplate">
            <views:EmployeeItemView />
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="1" />
            <RowDefinition Height="20" />
            <!-- 0: 上方连线区 (Top Lines) -->
            <RowDefinition Height="Auto" />
            <!-- 1: 卡片 (Card) -->
            <RowDefinition Height="20" />
            <!-- 2: 下方连线区 (Bottom Line) -->
            <RowDefinition Height="Auto" />
            <!-- 3: 子级 (Children) -->
        </Grid.RowDefinitions>

        <!-- ============================
          1. 上方连线区 (Top Lines) 
              这里处理复杂的横线逻辑
        ============================ -->

        <!-- 根节点不需要上方连线 -->

        <!-- B. 横线 (Horizontal): 连接兄弟节点 -->
        <!-- 默认情况下，横线是全宽的 (Stretch) -->
        <Border Grid.Row="0"
                Height="1"
                Background="#999999"
                VerticalAlignment="Top">
            <Border.Style>
                <Style TargetType="Border">
                    <!-- 默认显示 -->
                    <Setter Property="Visibility"
                            Value="Visible" />
                    <Setter Property="HorizontalAlignment"
                            Value="Stretch" />
                    <Setter Property="Width"
                            Value="NaN" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsRoot}"
                                     Value="True">
                            <Setter Property="Visibility"
                                    Value="Collapsed" />
                        </DataTrigger>
                        <!-- 情况1: 独生子 -> 没有横线 -->
                        <!--<DataTrigger Binding="{Binding IsSingleChild}"
                                     Value="True">
                            <Setter Property="Visibility"
                                    Value="Collapsed" />
                        </DataTrigger>-->

                        <!-- 情况2: 第一个孩子 -> 横线在右半边 -->
                        <!--<DataTrigger Binding="{Binding IsFirst}"
                                     Value="True">
                            <Setter Property="HorizontalAlignment"
                                    Value="Right" />
                            <Setter Property="Width"
                                    Value="{Binding RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type Border}}, Path=ActualWidth, Converter={converters:HalfValueConverter}}" />
                        </DataTrigger>-->

                        <!-- 情况3: 最后一个孩子 -> 横线在左半边 -->
                        <!--<DataTrigger Binding="{Binding IsLast}"
                                     Value="True">
                            <Setter Property="HorizontalAlignment"
                                    Value="Left" />
                            <Setter Property="Width"
                                    Value="{Binding RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type Border}}, Path=ActualWidth, Converter={converters:HalfValueConverter}}" />
                        </DataTrigger>-->
                    </Style.Triggers>
                </Style>
            </Border.Style>
        </Border>

        <!-- A. 竖线 (Vertical): 始终居中，连接到卡片 -->
        <Rectangle Grid.Row="1"
                   Width="1"
                   Fill="#999999"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Stretch">
            <Rectangle.Style>
                <Style TargetType="Rectangle">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsRoot}"
                                     Value="True">
                            <Setter Property="Visibility"
                                    Value="Collapsed" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Rectangle.Style>
        </Rectangle>

        <!-- ============================
          2. 员工卡片 (Card) 
         ============================ -->
        <Border x:Name="CardBorder"
                Grid.Row="2"
                Background="White"
                CornerRadius="8"
                BorderBrush="#E0E0E0"
                BorderThickness="1"
                Margin="10,0,10,0"
                Padding="15,10,15,10"
                MinWidth="120"
                HorizontalAlignment="Center">
            <ei:Interaction.Triggers>
                <ei:EventTrigger EventName="MouseLeftButtonDown">
                    <ei:ChangePropertyAction TargetObject="{Binding Path=DataContext,RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type UserControl}}}"
                                             PropertyName="IsSelected"
                                             Value="True" />
                </ei:EventTrigger>
                <ei:DataTrigger Binding="{Binding Path=IsSelected}"
                                Comparison="Equal"
                                Value="True">
                    <ei:ChangePropertyAction TargetObject="{Binding ElementName=CardBorder}"
                                             PropertyName="Background"
                                             Value="#EEE0E0" />
                </ei:DataTrigger>
                <ei:DataTrigger Binding="{Binding Path=IsSelected}"
                                Comparison="Equal"
                                Value="False">
                    <ei:ChangePropertyAction TargetObject="{Binding ElementName=CardBorder}"
                                             PropertyName="Background"
                                             Value="White" />
                </ei:DataTrigger>
            </ei:Interaction.Triggers>
            <Border.Effect>
                <DropShadowEffect BlurRadius="8"
                                  ShadowDepth="2"
                                  Direction="270"
                                  Color="#DDDDDD"
                                  Opacity="0.5" />
            </Border.Effect>
            <StackPanel HorizontalAlignment="Center">
                <TextBlock Text="{Binding Name}"
                           FontWeight="Bold"
                           FontSize="15"
                           Foreground="#333333"
                           HorizontalAlignment="Center" />
                <TextBlock Text="{Binding Title}"
                           FontSize="12"
                           Foreground="#888888"
                           Margin="0,4,0,0"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- ============================
         3. 下方连线区 (Bottom Line) 
            从卡片底部引出一条竖线，连接到下一层的“横线”
           仅当有下属时显示
        ============================ -->
        <Rectangle Grid.Row="3"
                   Width="1"
                   Fill="#999999"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Stretch"
                   Visibility="{Binding Children.Count,Converter={StaticResource CountToVis}}">
        </Rectangle>

        <!-- ============================
         4. 子级列表 (Children)
        ============================ -->
        <ItemsControl Grid.Row="4"
                      ItemsSource="{Binding Children}"
                      ItemTemplate="{StaticResource orgChartDataTemplate}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
        </ItemsControl>
    </Grid>
</UserControl>
