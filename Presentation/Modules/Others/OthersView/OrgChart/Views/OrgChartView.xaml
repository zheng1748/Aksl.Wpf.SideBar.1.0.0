<UserControl x:Class="Aksl.Modules.Others.OrgChart.Views.OrgChartView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:models="clr-namespace:Aksl.Modules.Others.OrgChart.Models"
             xmlns:converters="clr-namespace:Aksl.Modules.Others.OrgChart"
             xmlns:views="clr-namespace:Aksl.Modules.Others.Views"
             mc:Ignorable="d"
             d:DesignHeight="300"
             prism:ViewModelLocator.AutoWireViewModel="True">
    <UserControl.Resources>
        
        <converters:CountToVisibilityConverter x:Key="CountToVis" />

        <ItemsPanelTemplate x:Key="orgChartItemsPanelTemplate">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Center" />
        </ItemsPanelTemplate>

        <DataTemplate x:Key="orgChartDataTemplate">
            <views:EmployeeItemView />
        </DataTemplate>

        <DataTemplate x:Key="EmployeeTemplate"
                      DataType="{x:Type models:Employee}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="20" />
                    <!-- 0: 上方连线区 (Top Lines) -->
                    <RowDefinition Height="Auto" />
                    <!-- 1: 卡片 (Card) -->
                    <RowDefinition Height="20" />
                    <!-- 2: 下方连线区 (Bottom Line) -->
                    <RowDefinition Height="Auto" />
                    <!-- 3: 子级 (Children) -->
                </Grid.RowDefinitions>

                <!-- ============================
               1. 上方连线区 (Top Lines) 
               这里处理复杂的横线逻辑
               ============================ -->
                <Grid Grid.Row="0">
                    <!-- 根节点不需要上方连线 -->
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsRoot}"
                                             Value="True">
                                    <Setter Property="Visibility"
                                            Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>

                    <!-- A. 竖线 (Vertical): 始终居中，连接到卡片 -->
                    <Rectangle Width="1"
                               Fill="#999999"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Stretch" />

                    <!-- B. 横线 (Horizontal): 连接兄弟节点 -->
                    <!-- 默认情况下，横线是全宽的 (Stretch) -->
                    <Border Height="1"
                            Background="#999999"
                            VerticalAlignment="Top">
                        <Border.Style>
                            <Style TargetType="Border">
                                <!-- 默认显示 -->
                                <Setter Property="Visibility"
                                        Value="Visible" />
                                <Setter Property="HorizontalAlignment"
                                        Value="Stretch" />
                                <Setter Property="Width"
                                        Value="NaN" />
                                <!-- Auto -->

                                <Style.Triggers>
                                    <!-- 情况1: 独生子 -> 没有横线 -->
                                    <DataTrigger Binding="{Binding IsSingleChild}"
                                                 Value="True">
                                        <Setter Property="Visibility"
                                                Value="Collapsed" />
                                    </DataTrigger>

                                    <!-- 情况2: 第一个孩子 -> 横线在右半边 -->
                                    <DataTrigger Binding="{Binding IsFirst}"
                                                 Value="True">
                                        <Setter Property="HorizontalAlignment"
                                                Value="Right" />
                                        <Setter Property="Width"
                                                Value="{Binding RelativeSource={RelativeSource AncestorType=Grid}, Path=ActualWidth, Converter={converters:HalfValueConverter}}" />
                                    </DataTrigger>

                                    <!-- 情况3: 最后一个孩子 -> 横线在左半边 -->
                                    <DataTrigger Binding="{Binding IsLast}"
                                                 Value="True">
                                        <Setter Property="HorizontalAlignment"
                                                Value="Left" />
                                        <Setter Property="Width"
                                                Value="{Binding RelativeSource={RelativeSource AncestorType=Grid}, Path=ActualWidth, Converter={converters:HalfValueConverter}}" />
                                    </DataTrigger>

                                    <!-- 修正: 既是First又是Last? 即独生子，已被上面覆盖 -->
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>
                </Grid>

                <!-- ============================
               2. 员工卡片 (Card) 
               ============================ -->
                <Border x:Name="Card"
                        Grid.Row="1"
                        Background="White"
                        CornerRadius="8"
                        BorderBrush="#E0E0E0"
                        BorderThickness="1"
                        Margin="10,0"
                        Padding="15,10"
                        MinWidth="120"
                        HorizontalAlignment="Center">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="8"
                                          ShadowDepth="2"
                                          Direction="270"
                                          Color="#DDDDDD"
                                          Opacity="0.5" />
                    </Border.Effect>
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="{Binding Name}"
                                   FontWeight="Bold"
                                   FontSize="15"
                                   Foreground="#333333"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding Title}"
                                   FontSize="12"
                                   Foreground="#888888"
                                   Margin="0,4,0,0"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>

                <!-- ============================
               3. 下方连线区 (Bottom Line) 
               从卡片底部引出一条竖线，连接到下一层的“横线”
               仅当有下属时显示
               ============================ -->
                <Rectangle Grid.Row="2"
                           Width="1"
                           Fill="#999999"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Stretch"
                           Visibility="{Binding Subordinates.Count, Converter={StaticResource CountToVis}}" />

                <!-- ============================
               4. 子级列表 (Children)
               ============================ -->
                <ItemsControl Grid.Row="3"
                              ItemsSource="{Binding Subordinates}"
                              ItemTemplate="{DynamicResource EmployeeTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Center" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid Margin="4,4,4,4"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      PanningMode="Both">
            <Grid Margin="50">
                <ItemsControl ItemsSource="{Binding Employees}"
                              ItemsPanel="{StaticResource orgChartItemsPanelTemplate}"
                              ItemTemplate="{StaticResource orgChartDataTemplate}">
                    <!--<ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Center" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>-->
                </ItemsControl>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
